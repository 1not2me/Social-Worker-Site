{% extends "base.html" %}
{% block title %}× ×™×ª×•×—×™× ×¡×˜×˜×™×¡×˜×™×™× ×œ××¨×¦×™×{% endblock %}

{% block content %}
  <div class="page-wrap">
    <h1>× ×™×ª×•×—×™× ×¡×˜×˜×™×¡×˜×™×™×</h1>
    <p class="subtitle">×”×¢×œ×• ××ª ×§×•×‘×¥ ×”-CSV/XLSX ×©×œ ×ª×•×¦××•×ª ×”×©×™×‘×•×¥ (×›××• ×”×§×•×‘×¥ ×©××•×¨×™×“×™× ××”××¢×¨×›×ª).</p>

    <form method="post" enctype="multipart/form-data" class="upload-form">
      <div class="field">
        <label>×§×•×‘×¥ ×ª×•×¦××•×ª ×©×™×‘×•×¥ (CSV/XLSX)</label>
        <input type="file" name="results_file" required>
      </div>
      <div class="btn-wrap">
        <button class="primary-btn" type="submit">× ×ª×— ×§×•×‘×¥</button>
      </div>
    </form>

    {% if error %}
      <div class="flash error">{{ error }}</div>
    {% endif %}

    {% if tables %}
      <section class="card">
        <h2>ğŸ§¾ ×˜×‘×œ×”: ×¡×˜×•×“× ×˜×™× ×œ×›×œ ××§×•× ×”×›×©×¨×”</h2>
        <div class="table-wrap">
          <table>
            <thead><tr><th>{{ tables.cols.site }}</th><th>××¡×¤×¨ ×¡×˜×•×“× ×˜×™×</th></tr></thead>
            <tbody>
              {% for r in tables.by_site %}
                <tr><td>{{ r[tables.cols.site] }}</td><td>{{ r["××¡×¤×¨ ×¡×˜×•×“× ×˜×™×"] }}</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <h2>ğŸ·ï¸ ×˜×‘×œ×”: ×¡×˜×•×“× ×˜×™× ×œ×¤×™ ×ª×—×•× ×”×ª××—×•×ª</h2>
        <div class="table-wrap">
          <table>
            <thead><tr><th>{{ tables.cols.field }}</th><th>××¡×¤×¨ ×¡×˜×•×“× ×˜×™×</th></tr></thead>
            <tbody>
              {% for r in tables.by_field %}
                <tr><td>{{ r[tables.cols.field] }}</td><td>{{ r["××¡×¤×¨ ×¡×˜×•×“× ×˜×™×"] }}</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

      {% if tables.score_avg|length > 0 %}
      <section class="card">
        <h2>â­ ×××•×¦×¢ ××—×•×– ×”×ª×××” ×œ×¤×™ ××§×•×</h2>
        <div class="table-wrap">
          <table>
            <thead><tr><th>{{ tables.cols.site }}</th><th>×××•×¦×¢ ×”×ª×××”</th></tr></thead>
            <tbody>
              {% for r in tables.score_avg %}
                <tr><td>{{ r[tables.cols.site] }}</td><td>{{ r["×××•×¦×¢ ×”×ª×××”"] }}</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
      {% endif %}

      <section class="card">
        <h2>ğŸ“Š ×’×¨×¤×™×</h2>
        <div style="max-width:1000px;margin-inline:auto">
          <canvas id="chartSites"></canvas>
        </div>
        <div style="height:24px"></div>
        <div style="max-width:1000px;margin-inline:auto">
          <canvas id="chartFields"></canvas>
        </div>
        {% if charts.avg_labels|length > 0 %}
        <div style="height:24px"></div>
        <div style="max-width:1000px;margin-inline:auto">
          <canvas id="chartAvg"></canvas>
        </div>
        {% endif %}
      </section>

      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script>
        const charts = {{ charts|tojson }};
        new Chart(document.getElementById('chartSites'), {
          type: 'bar',
          data: { labels: charts.site_labels, datasets: [{ label: '××¡×¤×¨ ×¡×˜×•×“× ×˜×™×', data: charts.site_values }] },
          options: { responsive: true }
        });
        new Chart(document.getElementById('chartFields'), {
          type: 'bar',
          data: { labels: charts.field_labels, datasets: [{ label: '××¡×¤×¨ ×¡×˜×•×“× ×˜×™×', data: charts.field_values }] },
          options: { responsive: true }
        });
        if (charts.avg_labels && charts.avg_labels.length){
          new Chart(document.getElementById('chartAvg'), {
            type: 'line',
            data: { labels: charts.avg_labels, datasets: [{ label: '×××•×¦×¢ ×”×ª×××”', data: charts.avg_values }] },
            options: { responsive: true }
          });
        }
      </script>
    {% endif %}
  </div>
{% endblock %}
