{% extends "lecturer_base.html" %}
{% block title %}× ×™×ª×•×—×™× ×¡×˜×˜×™×¡×˜×™×™×{% endblock %}

{% block head %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="page-header" style="text-align: center;">
  <h1>× ×™×ª×•×—×™× ×¡×˜×˜×™×¡×˜×™×™×</h1>
  <p class="subtitle">×”×¢×œ×• ××ª ×§×•×‘×¥ ×”-CSV/XLSX ×©×œ ×ª×•×¦××•×ª ×”×©×™×‘×•×¥ (×›××• ×”×§×•×‘×¥ ×©××•×¨×™×“×™× ××”××¢×¨×›×ª).</p>
</div>

<div class="card" style="max-width: 700px; margin: 24px auto;">
  <form method="post" enctype="multipart/form-data" class="upload-form simple" style="align-items: center; gap: 16px;">
    
    <div class="field" style="width: 100%; text-align: center;">
      <label for="results_file_input" class="btn-outline">
        ğŸ“ ×‘×—×¨ ×§×•×‘×¥...
      </label>
      <input type="file" name="results_file" id="results_file_input" required>
      <div id="file-name-display" class="field-note" style="margin-top: 10px;">×œ× × ×‘×—×¨ ×§×•×‘×¥</div>
    </div>
    
    <div class="btn-wrap">
      <button class="primary-btn" type="submit">× ×ª×— ×§×•×‘×¥</button>
    </div>
    
  </form>
</div>

{% if error %}
  <div class="alert error" style="max-width: 700px; margin: 16px auto;">{{ error }}</div>
{% endif %}

{% if tables %}
  <section class="card">
    <h2>ğŸ§¾ ×˜×‘×œ×”: ×¡×˜×•×“× ×˜×™× ×œ×›×œ ××§×•× ×”×›×©×¨×”</h2>
    <div class="table-wrap">
      <table>
        <thead><tr><th>{{ tables.cols.site }}</th><th>××¡×¤×¨ ×¡×˜×•×“× ×˜×™×</th></tr></thead>
        <tbody>
          {% for r in tables.by_site %}
            <tr><td>{{ r[tables.cols.site] }}</td><td>{{ r["××¡×¤×¨ ×¡×˜×•×“× ×˜×™×"] }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <h2>ğŸ·ï¸ ×˜×‘×œ×”: ×¡×˜×•×“× ×˜×™× ×œ×¤×™ ×ª×—×•× ×”×ª××—×•×ª</h2>
    <div class="table-wrap">
      <table>
        <thead><tr><th>{{ tables.cols.field }}</th><th>××¡×¤×¨ ×¡×˜×•×“× ×˜×™×</th></tr></thead>
        <tbody>
          {% for r in tables.by_field %}
            <tr><td>{{ r[tables.cols.field] }}</td><td>{{ r["××¡×¤×¨ ×¡×˜×•×“× ×˜×™×"] }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  {% if tables.score_avg|length > 0 %}
  <section class="card">
    <h2>â­ ×××•×¦×¢ ××—×•×– ×”×ª×××” ×œ×¤×™ ××§×•×</h2>
    <div class="table-wrap">
      <table>
        <thead><tr><th>{{ tables.cols.site }}</th><th>×××•×¦×¢ ×”×ª×××”</th></tr></thead>
        <tbody>
          {% for r in tables.score_avg %}
            <tr><td>{{ r[tables.cols.site] }}</td><td>{{ r["×××•×¦×¢ ×”×ª×××”"] }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
  {% endif %}

  <section class="card">
    <h2>ğŸ“Š ×’×¨×¤×™×</h2>
    <div style="max-width:1000px;margin-inline:auto">
      <canvas id="chartSites"></canvas>
    </div>
    <div style="height:24px"></div>
    <div style="max-width:1000px;margin-inline:auto">
      <canvas id="chartFields"></canvas>
    </div>
    {% if charts.avg_labels|length > 0 %}
    <div style="height:24px"></div>
    <div style="max-width:1000px;margin-inline:auto">
      <canvas id="chartAvg"></canvas>
    </div>
    {% endif %}
  </section>

  <script>
    const charts = {{ charts|tojson }};
    const ctx1 = document.getElementById('chartSites');
    new Chart(ctx1, {
      type: 'bar',
      data: { labels: charts.site_labels, datasets: [{ label: '××¡×¤×¨ ×¡×˜×•×“× ×˜×™×', data: charts.site_values }] },
      options: { responsive: true }
    });
    const ctx2 = document.getElementById('chartFields');
    new Chart(ctx2, {
      type: 'bar',
      data: { labels: charts.field_labels, datasets: [{ label: '××¡×¤×¨ ×¡×˜×•×“× ×˜×™×', data: charts.field_values }] },
      options: { responsive: true }
    });
    if (charts.avg_labels && charts.avg_labels.length){
      const ctx3 = document.getElementById('chartAvg');
      new Chart(ctx3, {
        type: 'line',
        data: { labels: charts.avg_labels, datasets: [{ label: '×××•×¦×¢ ×”×ª×××”', data: charts.avg_values }] },
        options: { responsive: true }
      });
    }
  </script>
{% endif %}

<script>
  document.getElementById('results_file_input').addEventListener('change', function() {
    var fileName = this.files[0] ? this.files[0].name : '×œ× × ×‘×—×¨ ×§×•×‘×¥';
    document.getElementById('file-name-display').textContent = fileName;
  });
</script>

{% endblock %}
